<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phala Network Globe</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        #container {
            display: flex;
            height: 100vh;
            background: #f9fafb;
        }
        #globe-container {
            width: 50%;
            aspect-ratio: 1/1;
            margin: auto 0;
        }
        #sidebar {
            width: 50%;
            padding: 2rem;
            overflow-y: auto;
        }
        .node-card {
            padding: 1rem;
            margin-bottom: 0.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        .node-card:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .node-card.selected {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .node-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-gpu {
            background: #3b82f6;
            color: white;
        }
        .badge-cpu {
            background: #84cc16;
            color: white;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="globe-container"></div>
        <div id="sidebar">
            <h2>Phala Network Nodes</h2>
            <div id="node-list"></div>
            <div id="node-details" style="margin-top: 2rem;"></div>
        </div>
    </div>

    <script src="//unpkg.com/globe.gl"></script>
    <script>
        // Node data
        const nodes = [
            { name: 'prod01', city: 'New Delhi', country: 'India', countryCode: 'IN', lat: 28.6139, lon: 77.2090, type: 'CPU', hardware: 'Intel Xeon' },
            { name: 'prod02', city: 'Oakland', country: 'US', countryCode: 'US', lat: 37.8044, lon: -122.2712, type: 'GPU', hardware: 'NVIDIA H100' },
            { name: 'prod10', city: 'Paris', country: 'France', countryCode: 'FR', lat: 48.8566, lon: 2.3522, type: 'CPU', hardware: 'Intel TDX' },
            { name: 'prod11', city: 'London', country: 'UK', countryCode: 'GB', lat: 51.5074, lon: -0.1278, type: 'CPU', hardware: 'Intel Xeon' }
        ];

        let selectedNode = null;
        let globe = null;

        // Initialize globe
        fetch('//unpkg.com/world-atlas/countries-110m.json')
            .then(res => res.json())
            .then(countries => {
                const container = document.getElementById('globe-container');
                globe = Globe()(container)
                    .globeImageUrl('//unpkg.com/three-globe/example/img/earth-night.jpg')
                    .backgroundColor('#f9fafb')
                    .width(container.clientWidth)
                    .height(container.clientWidth)

                    // Hexagon polygons
                    .hexPolygonsData(countries.features)
                    .hexPolygonResolution(3)
                    .hexPolygonMargin(0.3)
                    .hexPolygonUseDots(true)
                    .hexPolygonColor(d => {
                        let code = d.properties.ISO_A2;
                        if (code === '-99' && d.properties.ADMIN === 'France') code = 'FR';

                        const hasNode = nodes.find(n => n.countryCode === code);
                        if (!hasNode) return '#6a6a6a';
                        return hasNode.type === 'GPU' ? '#8DD7FF' : '#BAE730';
                    })
                    .hexPolygonAltitude(0.001)

                    // HTML markers
                    .htmlElementsData(nodes)
                    .htmlLat(d => d.lat)
                    .htmlLng(d => d.lon)
                    .htmlAltitude(0.01)
                    .htmlElement(d => {
                        const wrapper = document.createElement('div');
                        wrapper.style.cssText = 'width:40px;height:40px;display:flex;align-items:center;justify-content:center;cursor:pointer';

                        const el = document.createElement('div');
                        const color = d.type === 'GPU' ? '#8DD7FF' : '#BAE730';
                        el.style.cssText = `width:16px;height:16px;border-radius:50%;background:${color};border:2px solid white;box-shadow:0 0 15px ${color}`;

                        wrapper.appendChild(el);
                        wrapper.onclick = () => selectNode(d);
                        return wrapper;
                    })

                    // Arcs
                    .arcsData(generateArcs())
                    .arcColor(d => d.color)
                    .arcDashLength(0.4)
                    .arcDashGap(0.2)
                    .arcDashAnimateTime(2000)
                    .arcStroke(0.5)
                    .arcAltitude(0.3)

                    // Ripples
                    .ringsData(nodes.map(n => ({
                        lat: n.lat,
                        lng: n.lon,
                        maxRadius: 30,
                        propagationSpeed: 2,
                        repeatPeriod: 2000,
                        color: n.type === 'GPU' ? ['#8DD7FF', '#6DB7DF'] : ['#BAE730', '#9AC720']
                    })))
                    .ringColor('color')
                    .ringMaxRadius('maxRadius')
                    .ringPropagationSpeed('propagationSpeed')
                    .ringRepeatPeriod('repeatPeriod')
                    .ringAltitude(0.002);

                globe.controls().autoRotate = false;
                globe.pointOfView({ lat: 30, lng: 0, altitude: 2 });
            });

        // Generate random arcs
        function generateArcs() {
            const arcs = [];
            nodes.forEach(source => {
                const numConnections = Math.floor(Math.random() * (nodes.length - 1)) + 1;
                const targets = nodes.filter(n => n !== source)
                    .sort(() => Math.random() - 0.5)
                    .slice(0, numConnections);

                targets.forEach(target => {
                    arcs.push({
                        startLat: source.lat,
                        startLng: source.lon,
                        endLat: target.lat,
                        endLng: target.lon,
                        color: source.type === 'GPU' ? ['#8DD7FF', '#6DB7DF'] : ['#BAE730', '#9AC720']
                    });
                });
            });
            return arcs;
        }

        // Render node list
        const nodeList = document.getElementById('node-list');
        nodes.forEach(node => {
            const card = document.createElement('div');
            card.className = 'node-card';
            card.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <strong>${node.name}</strong> - ${node.city}
                        <div style="font-size:0.875rem;color:#6b7280">${node.hardware}</div>
                    </div>
                    <span class="node-badge badge-${node.type.toLowerCase()}">${node.type}</span>
                </div>
            `;
            card.onclick = () => {
                selectNode(node);
                if (globe) {
                    globe.pointOfView({ lat: node.lat, lng: node.lon, altitude: 2 }, 1000);
                }
            };
            nodeList.appendChild(card);
        });

        // Select node function
        function selectNode(node) {
            selectedNode = node;

            // Update card selection
            document.querySelectorAll('.node-card').forEach((card, i) => {
                card.classList.toggle('selected', nodes[i] === node);
            });

            // Update details
            document.getElementById('node-details').innerHTML = `
                <h3>Node Details</h3>
                <p><strong>Name:</strong> ${node.name}</p>
                <p><strong>Location:</strong> ${node.city}, ${node.country}</p>
                <p><strong>Type:</strong> ${node.type}</p>
                <p><strong>Hardware:</strong> ${node.hardware}</p>
            `;
        }
    </script>
</body>
</html>
